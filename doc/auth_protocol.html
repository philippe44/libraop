<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
    <html>
      <head>
        <meta content="text/html; charset=utf-8" http-equiv="content-type">
        <title></title>
        <style type="text/css">
		p { color: #000000; font-family: "Times New Roman", serif; font-size: 12pt }
		p.msonormal { margin-bottom: 0.35cm; font-family: "Calibri", sans-serif; font-size: 11pt; line-height: 115% }
    p.msolistparagraph { margin-left: 1.27cm; margin-bottom: 0.35cm; font-family: "Calibri", sans-serif; font-size: 11pt; line-height: 115% }
		a:link { color: #0000ff }
		a:visited { color: #800080 }
	</style>
      </head>
      <body style="                                     color: black;" dir="ltr"

        lang="fr-FR" link="#0000ff" vlink="#800080">
        <p class="msonormal" style="margin-bottom: 0cm" lang="en-US"><font face="Segoe UI, sans-serif"><font

              style="font-size: 10pt" size="2"><i>Version 0.12</i></font></font></p>
        <h1 id="introduction" style="color: rgb(9, 89, 138); margin-top: 50px; margin-bottom: 20px; border-top: 2px solid rgb(9, 89, 138); border-bottom: 2px solid rgb(9, 89, 138); padding: 10px 20px; background-color: rgb(239, 248, 253); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">10.
          Pairing &amp; Authenticating</h1>
        <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify">
          <font style="font-size: 12pt" size="3"><font color="#000000"><font face="Segoe UI, sans-serif"><span

                  lang="en-US">Starting with i</span></font></font><font color="#000000"><font

                face="Segoe UI, sans-serif"><span lang="en-US"><span style="font-weight: normal">OS
                    10.</span></span></font></font><font color="#000000"><font face="Segoe UI, sans-serif"><span

                  lang="en-US">2, AppleTV has forced device authentication.
                  First, the AppleTV must register (pair) the device (only once)
                  and then pairing must be verified at every RTSP connection.
                  Most data are exchanged using Apple’s binary </span></font></font><font

              color="#000000"><font face="Courier New"><span lang="en-US"><b>plist</b></span></font></font><font

              color="#000000"> </font><font color="#000000"><font face="Segoe UI, sans-serif"><span

                  lang="en-US">format.</span></font></font></font></p>
        <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

          lang="en-US"> <font face="Segoe UI, sans-serif"><font class="msonormal"

              style="font-size: 12pt" size="3">It’s critical that the whole
              exchange (maybe except the /pair-pin-start) is done with the same
              socket, so make sure your HTTP library uses keep-alive (it is not
              mandatory, for AppleTV, to send the Connection: keep-alive, just
              make sure the HTTP tool you use does not close the connection once
              it has received an answer) . The example below use RTSP/1.0 but
              HTTP/1.0 seems to be usable with no difference. <br>
            </font></font></p>
        <p class="msonormal" style="margin-top: 0.66cm; margin-bottom: 0.4cm" lang="en-US">
          <span style="display: inline-block; border-top: none; border-bottom: 1.00pt solid #09598a; border-left: none; border-right: none; padding-top: 0cm; padding-bottom: 0.05cm; padding-left: 0cm; padding-right: 0cm"><font

              face="Segoe UI, sans-serif"><font style="font-size: 18pt" size="5"><b><font

                    color="#09598a">10.1. RTSP pairing (required only
                    once)</font></b></font></font></span></p>
        <p class="msonormal" style="margin-top: 0.26cm; margin-bottom: 0.5cm" lang="en-US">
          <font color="#09598a"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

                size="3"><b>START</b></font></font></font><font color="#000000"><font

              face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><span

                  lang="en-US"><br>
                </span></font></font></font></p>
        <p class="msonormal" style="margin-top: 0.26cm; margin-bottom: 0.5cm" lang="en-US"><font

            color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

                size="3"><span lang="en-US">The </span></font></font></font><font

            color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

                size="3"><span lang="en-US"><b>pair-pin-start </b></span></font></font></font><font

            color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

                size="3"><span lang="en-US">POST reque</span></font></font></font><font

            color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

                size="3"><span lang="en-US">st starts the procedure</span></font></font></font>
        </p>
        <p class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client
          → server</p>
        <pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-pin-start RTSP/1.0
Connection: keep-alive<br></code></pre><p class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p><pre

style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK
Server: AirTunes/320.20</code></pre><font color="#09598a"><font face="Segoe UI, sans-serif"><font

style="font-size: 13pt" size="3"><span lang="en-US"><b>STEP
                1 - CONFIRM PIN</b></span></font></font></font><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><br><br>The
          <b>pair-setup-pin </b>POST request is used to display a PIN code on
          the AppleTV.<br></font></font><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><br>Build
a
          <b>plist</b> :</font></font><table style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0"><colgroup><col style="text-align: left;"><col style="text-align: left;"><col

style="text-align: left;"><col style="text-align: left;"></colgroup><thead><tr style="background-color: rgb(241, 248, 253);"><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left; width: 80.9333px;"><b>user</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 79.2833px;">&lt;unique id&gt;</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 69.5837px;">16</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 375.7px;">Up to 16 bytes unique ID to describe the device (e.g. MAC address)</td></tr><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>method</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">pin</td><td style="padding: 5px; font-size: 9pt; text-align: left;">3</td><td

style="padding: 5px; font-size: 9pt; text-align: left;">String 'pin' - AppleTV displays a 4 digit pin code</td></tr></tbody></table><p

class="msonormal" style="margin-left: 0.79cm; margin-right: 0.26cm; margin-top: 0.26cm; margin-bottom: 0cm; text-transform: uppercase"><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US"></span></font></font></font>
</p><p class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client → server</p>
<pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-setup-pin RTSP/1.0
Content-Type: application/x-apple-binary-plist
Content-Length: 86
Connection: keep-alive
bplist00.....VmethodTuserSpin_..00:01:02:03:04:05. ..................................1<br></code></pre><p><font

face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">The AppleTV response is a <b>plist :</b></font></font></p><p><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><span lang="en-US"></span></font></font></font></p><table style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0"><thead><tr style="background-color: rgb(241, 248, 253);"><th style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left; width: 80.9333px;"><b>pk</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 79.2833px;">&lt;B&gt;</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 69.5837px;">256</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 375.7px;">256 bytes public key from AppleTV</td></tr><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>salt</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">&lt;salt&gt;</td><td style="padding: 5px; font-size: 9pt; text-align: left;">16</td><td

style="padding: 5px; font-size: 9pt; text-align: left;"><font face="Segoe UI, sans-serif"><font

style="font-size: 9pt" size="2">Received salt from AppleTV</font></font></td></tr></tbody>
</table>
<p class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p><pre

style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK
Content-Length: 342
Content-Type: application/x-apple-binary-plist
Server: AirTunes/320.20
bplist00.....RpkTsaltO....c.Li.4...L.............~....%k#..P2.5...G.U..Y..R..&lt;...r..O....f#.|5ds........Nd..PtSp.g.....S..A..k..c.N...D.B$../....|..^.Y...J^I...h;.
.|6........H.H.8q8....L........]fw....k.....|..7B&gt;....6.z....+.9Es.7(...8E...j.W....U
...f..`.H...HE........onv&gt;f.O......7.;&amp;C..U.z@{... ......….….......................,</code></pre><font

color="#09598a"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><b>STEP
              2 - run S</b><b>RP</b></font></font></font><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><br><br>Generate
locally
          a 32 bytes random <b>auth_secret</b>&nbsp;(named &lt;a&gt;)
          that will be used for all further verification with the AppleTV - DO
          NOT LOOSE IT. </font></font>
    
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">From
that
          secret, create a public key &lt;a_pub&gt; using a Ed25519
          (&nbsp;Edwards-curve Digital Signature Algorithm&nbsp;- EdDSA) – it
          will be needed later, but can be re-created at any time.</font></font></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm">
      <font color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US"><u><b>Advice:</b></u></span></font></font></font><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US">&nbsp;read
              SRP6 documentation at </span></font></font></font><font color="#000000"><font

face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><span lang="en-US"><b><a

href="http://srp.stanford.edu/design.html">http://srp.stanford.edu/design.html</a>
              </b></span></font></font></font><font color="#000000"><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><span lang="en-US">to
              get a&nbsp;</span></font></font></font><font color="#000000"><font

face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><span lang="en-US"></span></font></font></font><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US">better
              idea of the protocol: <br>
            </span></font></font></font></p>
    <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:black;mso-ansi-language:EN-US" lang="EN-US">&nbsp; N&nbsp;&nbsp;&nbsp; A
        large safe
        prime (N = 2q+1, where &nbsp;&nbsp; from SHA-1,
        2048<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; q is
        prime) All arithmetic is done.<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        modulo N<br>
        &nbsp; g&nbsp;&nbsp;&nbsp; A generator
        modulo
N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
“&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        “<br>
        &nbsp; H()&nbsp; One-way hash
function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
“&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        “<br>
        &nbsp; k&nbsp;&nbsp;&nbsp; Multiplier
        parameter &nbsp; </span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:black;mso-ansi-language:EN-US" lang="EN-US"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:black;mso-ansi-language:EN-US" lang="EN-US">&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; calculated by
          SRP<br>
        </span>&nbsp; S&nbsp;&nbsp;&nbsp; shared
        secret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
calculated
        by SRP<br>
        &nbsp; K&nbsp;&nbsp;&nbsp; shared secret
        hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;K&gt;
        calculated by SRP (AppleTV special)<br>
        &nbsp; s&nbsp;&nbsp;&nbsp; User's
        salt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;salt&gt;
        received in step 1<br>
        &nbsp; I&nbsp;&nbsp;&nbsp;
        Username&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;unique
        id&gt; of the client device<br>
        &nbsp; p&nbsp;&nbsp;&nbsp; Cleartext
        Password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;pin&gt;
        as it appears on ATV screen<br>
        &nbsp; ^&nbsp;&nbsp;&nbsp; (Modular)
        Exponentiation<br>
        &nbsp; u&nbsp;&nbsp;&nbsp; Random
        scrambling
        parameter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
calculated
        by SRP</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:black;mso-ansi-language:EN-US" lang="EN-US"><br>
        &nbsp; a,b&nbsp; Secret ephemeral
        values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
a
        = &lt;auth_secret&gt;, A = g^a % N
        (calculated by SRP)<br>
        &nbsp; A,B&nbsp; Public ephemeral
        values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        A = calculated by SRP, B = received from AppleTV <br>
        &nbsp; x&nbsp;&nbsp;&nbsp; Private key
        (derived from p and s)&nbsp;&nbsp;&nbsp;&nbsp; calculated by SRP<br>
        &nbsp; v&nbsp;&nbsp;&nbsp; Password
        verifier&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        calculated by SRP<br>
      </span></p>
    
    <p class="msonormal" style="margin-top: 0.35cm; margin-bottom: 0.4cm" align="justify">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><span

lang="en-US"><u><b>Note:</b></u></span></font></font><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><span lang="en-US">&nbsp;some
            SRP libraries seems to generate the proof M1 with </span></font></font>
    </p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <span style="display: inline-block; border: none; padding: 0cm"><font style="font-size: 12pt"

size="3"><font face="Courier New"><font style="font-size: 10pt" size="2"><span style="font-weight: normal"><span

style="background: transparent"><font face="Segoe UI, sans-serif">&nbsp;&nbsp;&nbsp; M1
                    = H( H(N) ^ </font></span></span></font><font face="Courier New"><font

style="font-size: 10pt" size="2"><u><span style="font-weight: normal"><span style="background: transparent">H(PAD(g))</span></span></u></font></font><font

face="Courier New"><font style="font-size: 10pt" size="2"><span style="font-weight: normal"><span

style="background: transparent">
                    | H(I) | s | PAD(A) | PAD(B) | K )</span></span></font></font></font></font></span><font

style="font-size: 12pt" size="3"><font face="Courier New">
        </font></font>
    </p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">but
AppleTV
          does not want &lt;g&gt; to be padded, so simply modify your
          tool to do </font></font>
    </p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm; font-weight: normal"

align="justify" lang="en-US">
      <span style="display: inline-block; border: none; padding: 0cm"><font style="font-size: 10pt"

size="2"><span style="background: transparent"><font face="Courier New">
              &nbsp;&nbsp;&nbsp; M1
              = H( H(N) ^ <u>H(g)</u> | H(I) | s | PAD(A) | PAD(B) | K )</font></span></font></span></p>
    <p class="msonormal" style="margin-top: 0.35cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><i

class="msonormal">(NB
:
            ‘|’ represents a byte array concatenation, not a logical “or”
            and ^ is XOR)</i></font></font></p>
    <p class="msonormal" style="margin-top: 0.35cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><u><b>Note:</b></u>&nbsp;The
calculation
          of &lt;K&gt;, the shared secret hash is not compliant with
          default SRP6</font></font></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm; font-weight: normal"

align="justify" lang="en-US">
      <span style="display: inline-block; border: none; padding: 0cm"><font style="font-size: 10pt"

size="2"><span style="background: transparent"><font face="Courier New">&nbsp;&nbsp;&nbsp; K
              =H(S) </font></span></font></span>
    </p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">but
AppleTV
          requires </font></font>
    </p>
    <p class="msonormal" style="margin-top: 0.26cm; margin-bottom: 0.26cm; font-weight: normal"

lang="en-US">
      <span style="display: inline-block; border: none; padding: 0cm"><font style="font-size: 10pt"

size="2"><span style="background: transparent"><font face="Courier New">&nbsp;&nbsp;&nbsp; K
              = H(S | \x00\x00\x00\x00) | H(S | \x00\x00\x00\x01)</font></span></font></span></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">Now
feed
          the modified SRP library with &lt;unique id&gt;, &lt;pin&gt;,
          &lt;salt&gt;, &lt;A&gt;, &lt;B&gt; and it will give you M1. <br></font></font></p><p

class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">Build a
          <b>plist:</b></font></font></p><p><font color="#000000"><font face="Segoe UI, sans-serif"><font

style="font-size: 13pt" size="3"><span lang="en-US"></span></font></font></font></p>
<table style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0">
<thead><tr style="background-color: rgb(241, 248, 253);"><th style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left; width: 80.9333px;"><b>pk</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 79.2833px;">&lt;A&gt;</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 69.5837px;">256</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 375.7px;">The SRP6 public key corresponding to &lt;a&gt; (A = g ^&lt;a&gt; % N).<br>Should be calculated by the SRP library</td></tr><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>proof</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">&lt;M1&gt;</td><td style="padding: 5px; font-size: 9pt; text-align: left;">20</td><td

style="padding: 5px; font-size: 9pt; text-align: left;"><font face="Segoe UI, sans-serif"><font

style="font-size: 9pt" size="2">The
                  SRP6 public key corresponding to &lt;a&gt; (A = g ^&lt;a&gt; %                  N).<br>
                  Should be calculated by the SRP library</font></font></td></tr></tbody></table><p

class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client
          → server</p>
        
<pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-setup-pin RTSP/1.0
Content-Type: application/x-apple-binary-plist
Content-Length: 347
Connection: keep-alive
bplist00.....RpkUproofO.....~.!..S|..5..M..)7..r.?.....j.N..0...[K.uu.. q+..O.0...c.!...\O......*.[k(.6.?Mv..-yS.......;k..n...@5....9.@.K.N.. ..... V.._k..........E.^}0.&amp;...mvwpA=)X.}....OF...JZQ...o.,..(..G.g.{...0....wj,?...........G.m,..... .0.)..S....7...1.Q9PA.ni.d=....&lt;=..}.O..2....d...... ..Z..j.... .....................................1<br></code></pre><code

style="font-weight: bold;">
</code><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">The AppleTV response is a <b>plist :<br></b></font></font><table

style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0"><thead><tr style="background-color: rgb(241, 248, 253);"><th style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>proof</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">&lt;M2&gt;</td><td style="padding: 5px; font-size: 9pt; text-align: left;">64</td><td

style="padding: 5px; font-size: 9pt; text-align: left;"><font face="Segoe UI, sans-serif"><font

style="font-size: 9pt" size="2">The M2 proof calculated by the server</font></font></td></tr></tbody>
</table><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">This
&lt;M2&gt;
          can be checked against the &lt;M2&gt; calculated by SRP
          for verification on the client side, It is
          optional for the client to verify this because if the
          AppleTV detects an error, an HTTP 470 will be responded.</font></font><p

class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p><pre

style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK 
Content-Length: 75 
Content-Type: application/x-apple-binary-plist 
Server: AirTunes/320.20 
bplist00...UproofO...G.f.)....A....q.P)...................................(
</code></pre><font color="#09598a"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><b>STEP
              3 (run AES)</b></font></font></font><br><br><p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm"

align="justify" lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">This
last
          step is to confirm the secret <b>auth_secret</b>&nbsp;&lt;a&gt;.
          It requires a sha512 digest, and an AES encryption in GCM (Galois
          Counter Mode, which provides encryption and signature). This builds an
          encrypted message &lt;epk&gt; with its signed &lt;authTag&gt;. <br></font></font>
        </p>
        <ol type="1"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3">
          <li>Create the AES key with the first 16 bytes of a sha512 digest made with<ul>
         	 <li>The string “Pair-Setup-AES-Key” (in UTF-8)</li>
            <li>The shared secret hash from SRP6 &lt;K&gt; (see above)</li></ul></li>
    		<li>Create the AES IV with the first 16 bytes of a sha512 digest made with<ul>
          <li>The string “Pair-Setup-AES-IV” (in UTF-8)</li>
          <li>The shared secret hash from SRP6 &lt;K&gt; (see above)</li>
          <li>Add 0x01 to the last byte of the AES IV key</li></ul></li>
			<li>Use this AES key and IV to encode the public key &lt;a_pub&gt;created with Ed25519 using AES in GCM<ul>
        <li>The encrypted data is &lt;epk&gt; and the signature is &lt;authTag&gt;</li></ul></li></font></font></ol><font

face="Segoe UI, sans-serif">
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"><font

face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">Build a
          <b>plist:</b></font></font>
</p></font><p><font color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><span lang="en-US"></span></font></font></font></p>
<table style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0">
<thead><tr style="background-color: rgb(241, 248, 253);"><th style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left; width: 80.9333px;"><b>epk</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 79.2833px;">&lt;epk&gt;</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 69.5837px;">32</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 375.7px;">Encrypted data</td></tr><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>authTag</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">&lt;tag&gt;</td><td style="padding: 5px; font-size: 9pt; text-align: left;">64</td><td

style="padding: 5px; font-size: 9pt; text-align: left;"><font face="Segoe UI, sans-serif"><font

style="font-size: 9pt" size="2">Signature of data</font></font></td></tr></tbody>
</table><p class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client
          → server</p>
        
<pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-setup-pin RTSP/1.0
Content-Type: application/x-apple-binary-plist
Content-Length: 116
bplist00.....SepkWauthTagO. .p..^.......vLk.&amp;....&amp;.(A.].....O..K...sW.&amp;#..Q..... ..&lt;...............................O<br></code></pre><font

color="#09598a"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><span lang="en-US"></span></font></font></font><font face="Segoe UI, sans-serif"><p

class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">If
the
          message is correct, the AppleTV should responds with a HTTP 200
          and a <b>plist </b>which means that the <b>auth_secret</b> &lt;a&gt;
          is now registered in the AppleTV as a valid secret<br></font></font></p></font><p><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><span lang="en-US"></span></font></font></font></p>
<table style="border-collapse: separate; margin: 10px 10px 30px 30px; width: 660px; color: black; font-family: &quot;Segoe UI&quot;,&quot;Lucida Grande&quot;,&quot;Trebuchet MS&quot;,Arial,&quot;lucida sans unicode&quot;,sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; text-decoration-style: initial; text-decoration-color: initial;"

border="0">
<thead><tr style="background-color: rgb(241, 248, 253);"><th style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">TAG</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">VALUE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">SIZE</th><th

style="color: #4381a7; font-variant: small-caps; font-size: 12pt; height: 30px; background: #c8e3f9 none repeat scroll 0% 0%; padding: 5px; text-align: left;">DESCRIPTION</th></tr></thead><tbody><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left; width: 80.9333px;"><b>epk</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 79.2833px;">&lt;epk&gt;</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 69.5837px;">32</td><td

style="padding: 5px; font-size: 9pt; text-align: left; width: 375.7px;">unused</td></tr><tr

style="background-color: rgb(241, 248, 253);"><td style="padding: 5px; font-size: 9pt; text-align: left;"><b>authTag</b></td><td

style="padding: 5px; font-size: 9pt; text-align: left;">&lt;tag&gt;</td><td style="padding: 5px; font-size: 9pt; text-align: left;">64</td><td

style="padding: 5px; font-size: 9pt; text-align: left;"><font face="Segoe UI, sans-serif"><font

style="font-size: 9pt" size="2">unused</font></font></td></tr></tbody>
</table><font face="Segoe UI, sans-serif"><p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm"

align="justify" lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 13pt" size="3">These
parameters
          do not seem to be used later in the protocol</font></font></p></font><p

class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p><pre

style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK
Content-Length: 116
Content-Type: application/x-apple-binary-plist
Server: AirTunes/320.20
bplist00.....SepkWauthTagO. K.@O...E.&amp;ED...Q<br></code></pre><font face="Segoe UI, sans-serif"><p

class="msonormal" style="margin-top: 0.66cm; margin-bottom: 0.4cm" lang="en-US">
      <span style="display: inline-block; border-top: none; border-bottom: 1.00pt solid #09598a; border-left: none; border-right: none; padding-top: 0cm; padding-bottom: 0.05cm; padding-left: 0cm; padding-right: 0cm"><font

face="Segoe UI, sans-serif"><font style="font-size: 18pt" size="5"><b><font color="#09598a">10.2.
                RTSP session authentication</font></b></font></font></span></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">Now,
before
          initialing any audio, video or exchange with the AppleTV, each
          RTSP session must be authenticated. This means that after a TEARDOWN,
          the same protocol must happen again (only the authentication, not the
          pairing). The <b>auth_secret</b> &lt;a&gt; will now be used</font></font></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font color="#09598a"><font face="Segoe UI, sans-serif"><font style="font-size: 13pt"

size="3"><b>STEP
              1 – CREATE NEW KEYS</b></font></font></font></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify">
      <font color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US">Generate
              locally a random 32 bytes number and use a Curve25519 </span></font></font></font><a

href="https://en.wikipedia.org/wiki/Elliptic_curve_Diffie%E2%80%93Hellman"><font

color="#000000"><span style="text-decoration: none"><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3"><span lang="en-US">elliptic
                  curve Diffie–Hellman</span></font></font></span></font></a><font

color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US">&nbsp;(ECDH)
              algorithm to build a verifier key pair &lt;v_pub&gt; and
              &lt;v_priv&gt;
              (32 bytes each). </span></font></font></font>
    </p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">As
above,
          retrieve the public key &lt;a_pub&gt; from the <b>auth_secret</b>
          &lt;a&gt; using Ed25519 (Edwards-curve Digital Signature
          Algorithm&nbsp;- EdDSA)</font></font></p>
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 13pt" size="3"><font

style="font-size: 12pt" size="3">Concatenate
            &lt;v_pub&gt; and &lt;a_pub&gt;, lead by a 4 bytes header</font>
          <font style="font-size: 12pt" size="3">“\0x01\0x00\0x00\0x00” and
            send this in the body of an HTTP POST request (68 bytes): <br></font></font></font></p><p

class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US"><span style="display: inline-block; border: none; padding: 0cm"><font

style="font-size: 10pt" size="2"><span style="background: transparent"><font face="Courier New">&nbsp;&nbsp;&nbsp; body =&nbsp;&nbsp;&nbsp;&nbsp; “\0x01\0x00\0x00\0x00”&lt;v_pub&gt;&lt;a_pub&gt; </font></span></font></span></p><p

class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US"><font color="#000000"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt"

size="3"><span lang="en-US">This is NOT a </span></font></font></font><font color="#000000"><font

face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><span lang="en-US"><b>plist</b></span></font></font></font>
    
    </p></font><p class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client
      → server</p>
    <pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-verify RTSP/1.0
Content-Type: application/octet-stream
Content-Length: 68
....\5...4...Q..J..C...b.CiT@R....s.&gt;+..qQ.. .&gt;+..qQ..<br></code></pre><font

face="Segoe UI, sans-serif"><p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm"

align="justify" lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">The
AppleTV
          responds with a body containing 96 bytes of data. Again, this is NOT
          a <b>plist</b>, but just plain binary. The first 32 bytes are an AppleTV
          public key &lt;atv_pub&gt; and the remaining bytes (usually 64) are
          some data &lt;atv_data&gt; to be used in next step.</font></font></p></font><p

class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p><pre

style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK
Content-Length: 96
Content-Type: application/octet-stream
Server: AirTunes/320.20.1
.............9...%....bN.KL9$k....N.........k.)...kI-..s_T...r.......Y.......9.41..h6..g....-..</code></pre><font

face="Segoe UI, sans-serif"><p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm"

align="justify" lang="en-US"><font color="#09598a"><font face="Segoe UI, sans-serif"><font

style="font-size: 13pt" size="3"><b>STEP
              2 - AES</b></font></font></font></p></font><font face="Segoe UI, sans-serif">
    <p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm" align="justify"

lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">This
last
          step is to finalize the verification. It requires Ed25519,
          Curve25519, a sha512 digest, and an AES encryption in CTR (Counter)
          mode. This provides an encrypted message that will be sent in an
          HTTP/RTSP body</font></font></p></font><ol type="1"><font face="Segoe UI, sans-serif"><font

size="3"><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3"><li><font

face="Segoe UI, sans-serif"><font size="3"><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3">Create a shared secret &lt;shared&gt; between &lt;v_priv&gt; and &lt;atv_pub&gt;, using Curve25519 algorithm</font></font></font></font></li><li><font

face="Segoe UI, sans-serif"><font size="3"><font face="Segoe UI, sans-serif"><font

style="font-size: 12pt" size="3">Use
 Ed25519 signature algorithm to sign the concatenation of &lt;v_pub&gt; 
and &lt;atv_pub&gt; (in that order), using the keypair &lt;a_pub&gt; and
 &lt;a&gt;. Call the result &lt;signed&gt;</font></font></font></font></li><li>Create the AES key with the first 16 bytes of a sha512 digest made with<br><ul><li>The string “Pair-Verify-AES-Key” (in UTF-8)</li><li>The shared secret &lt;shared&gt; created on using Curve25519</li></ul></li>
    		<li>Create the AES IV with the first 16 bytes of a sha512 digest made with<ul><li>The string “Pair-Verify-AES-IV” (in UTF-8)</li><li>The shared secret &lt;shared&gt; created on using Curve25519</li></ul></li>
  <li><font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">Use this AES key and IV to build a signature by encoding 
&lt;atv_data&gt; and &lt;signed&gt;. Encrypt &lt;atv_data&gt; first, discard the result and then encrypt &lt;signed&gt;. Although the first 
encrypted data is discarded, this is important due to the counter feature of AES CTR<ul><li>Encrypt &lt;atv_data&gt;, discard result</li><li>Encrypt &lt;signed&gt; and keep result as the signature &lt;signature&gt; (64 bytes)</li></ul></font></font></li><li>Concatenate this &lt;signature&gt; with a 4 bytes header “\0x00\0x00\0x00\0x00” and send this in the body of an HTTP POST request (68 bytes):</li></font></font></font></font>
</ol><font face="Segoe UI, sans-serif">
    </font><p class="cli_srv" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(255, 204, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">client
      → server</p>
    
<pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">POST /pair-verify RTSP/1.0
Content-Type: application/octet-stream
Content-Length: 68
....F.ATu.:.{..............X......."D2.C!....R;.P~....-....4.ZT......</code></pre><font

face="Segoe UI, sans-serif"><p class="msonormal" style="margin-top: 0.08cm; margin-bottom: 0.4cm"

align="justify" lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">The
AppleTV
          should respond with an HTTP/RTSP 200 and the session (socket)
          is valid</font></font></p>
    </font><p class="srv_cli" style="margin: 10px 10px 0px 30px; text-align: justify; background-color: rgb(204, 255, 204); border-top: 1px dashed rgb(170, 170, 170); border-right: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-bottom: none; padding: 5px; width: 650px; overflow: auto; font-size: 12.8px; font-variant: small-caps; font-weight: bold; color: rgb(0, 0, 0); font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Trebuchet MS&quot;, Arial, &quot;lucida sans unicode&quot;, sans-serif; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server → client</p>
<pre style="background-color: rgb(239, 248, 253); border-right: 1px dashed rgb(170, 170, 170); border-bottom: 1px dashed rgb(170, 170, 170); border-left: 1px dashed rgb(170, 170, 170); border-image: initial; border-top: none; padding: 5px; margin: 0px 10px 30px 30px; width: 650px; overflow: auto; font-weight: bold; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;"><code

style="font-weight: bold;">RTSP/1.0 200 OK
Content-Length: 0
Content-Type: application/octet-stream
Server: AirTunes/320.20.1</code></pre><font face="Segoe UI, sans-serif"><p class="msonormal"

style="margin-top: 0.66cm; margin-bottom: 0.4cm" lang="en-US">
      <span style="display: inline-block; border-top: none; border-bottom: 1.00pt solid #09598a; border-left: none; border-right: none; padding-top: 0cm; padding-bottom: 0.05cm; padding-left: 0cm; padding-right: 0cm"><font

face="Segoe UI, sans-serif"><font style="font-size: 18pt" size="5"><b><font color="#09598a">10.3.
                Test vector</font></b></font></font></span></p>
    <p class="msonormal" style="margin-bottom: 0.26cm" align="justify" lang="en-US">
      <font face="Segoe UI, sans-serif"><font style="font-size: 12pt" size="3">As
this
          is an awful lot of cryptography where everything can and will go
          wrong, so here is a test vector to verify that you do step by step</font></font></p><p

class="msonormal" style="margin-bottom: 0.26cm" align="justify" lang="en-US"><font

face="Segoe UI, sans-serif"><font style="font-size: 10pt" size="3"><code>PAIRING<br></code></font></font></p><p

class="msonormal" style="margin-bottom: 0.26cm" align="justify" lang="en-US"><font

face="Segoe UI, sans-serif"><font style="font-size: 10pt" size="3"><code>&lt;ID&gt;&nbsp;&nbsp;&nbsp; :366B4165DD64AD3A (as a string, not an HEX value)<br>
        &lt;pk&gt;&nbsp;&nbsp;&nbsp;&nbsp;:4223ddb35967419ddfece40d6b552b797140129c1c262da1b83d413a7f9674aff834171336dabadf9faa95962331e44838d5f66c46649d583ee44827755651215dcd5881056f7fd7d6445b844ccc5793cc3bbd5887029a5abef8b173a3ad8f81326435e9d49818275734ef483b2541f4e2b99b838164ad5fe4a7cae40599fa41bd0e72cb5495bdd5189805da44b7df9b7ed29af326bb526725c2b1f4115f9d91e41638876eeb1db26ef6aed5373f72e3907cc72997ee9132a0dcafda24115730c9db904acbed6d81dc4b02200a5f5281bf321d5a3216a709191ce6ad36d383e79be76e37a2ed7082007c51717e099e7bedd7387c3f82a916d6aca2eb2b6ff3f3<br>
        &lt;salt&gt;&nbsp;&nbsp;:d62c98fe76c77ad445828c33063fc36f<br>
        &lt;A&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:47662731cbe1ba0b130dc5e65320dc2a4b60371e086212a7a55ed4a3653b2d1e861569309c97b4f88433564bd47f6de13ecc440db26998478b266eaa8195a81c28f89a989bc538c477be302fd96bb3fa809e9a94b0aac28d6a00aa057892ba26b2b2cad4d8ec6a9e4207754926c985c393feb6e8b7fb82bd8043709866d7b53a592a940d8e44a7d08fbbda51bf5c9091c251988236147364cb75ad5a4efbeed242fd78496f0cda365965255c8214bd264c259fa2f2a8bfec70eecb32d2ded4c5c35e5e802a22bf58f7cd629fb2f3b4a2498b95f63eab37be9fb0f75c3fcbea8c083d0311302ebc2c3bc0a0525ba5bf3fcffe5b5668b4905a8e6cdb70d89f4b1b<br>&lt;a&gt;&nbsp;&nbsp;&nbsp;&nbsp; :a18b940d3e1302e932a64defccf560a0714b3fa2683bbe3cea808b3abfa58b7d<br>&lt;a_pub&gt; :0ceaa63dedd87d2da05ff0bdfbd99b5734911269c70664b9a74e04ae5cdbeca7<br>&lt;M1&gt;&nbsp;&nbsp;&nbsp; :4b4e638bf08526e4229fd079675fedfd329b97ef<br>&lt;K&gt;&nbsp;&nbsp;&nbsp;&nbsp; :9a689113a76b44583e73f9662eb172e830886ed988f04c6c0030f0e93c68784de27dbf30c5d151fb<br>&lt;pin&gt;&nbsp;&nbsp; :1234 (as a string)<br>&lt;aes_key&gt;&nbsp;&nbsp; :a043357cee40a9ae0731dd50859cccfb<br>&lt;aes_iv&gt;&nbsp;&nbsp;&nbsp; :da36ea69a94d51d881086e9080dbaef8<br>&lt;epk&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :5de0f61622b0d41bc098b07f229863f49e1a1c1030908b0ec620386e089a20c4<br>&lt;tag&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :3b13d2e85f00555c6a05df5cb03a2105</code></font></font></p><p

class="msonormal" style="margin-bottom: 0.26cm" align="justify" lang="en-US"><font

face="Segoe UI, sans-serif"><font style="font-size: 10pt" size="3"><code>VERIFYING<br></code></font></font></p><p

class="msonormal" style="margin-top: 0.66cm; margin-bottom: 0.4cm" lang="en-US"><font

face="Segoe UI, sans-serif"><font style="font-size: 10pt" size="3"><code>&lt;v_pub&gt; &nbsp;&nbsp;&nbsp; :f5078944f29ec2bc3ffe5b04e17772b884ce6d1f88e255582e8b35dda8fa7f35<br>
        &lt;atv_pub&gt;&nbsp;&nbsp;&nbsp;:d62c8c9548d836736978ad4d426df3495192407bbbb9466c9970794cdd2fe43a<br>
        &lt;atv_data&gt;&nbsp;&nbsp;:3067a3ea868ade5c9fab43a8d5dc4d53ca1115dbf1c882888f877e85b65c3a82a61583f24c33bf0b9a6ec5c4ab2ecc555a939e7633557453854795e82f2d7ef6<br>&lt;shared&gt;&nbsp;&nbsp;&nbsp; :b7085ca45bd640d966525cbdbc0745bd1d80aa6e6ee48270b60affba3cccac31<br>
        &lt;aes_key&gt;&nbsp;&nbsp; :2556d9ef1780c8283eecf259fc7207af<br>&lt;aes_iv&gt;&nbsp;&nbsp;&nbsp; :453404da307f780e6d50e52d7dc62325<br>
        &lt;signed&gt;&nbsp;&nbsp;&nbsp;&nbsp;:82a0cf6cdba66df407fdeb51ac3884748e3a47c8de3f681d534299e707428ce19f6822d2bf925c5d197f1042e7c5b7160a764e42f9fbe33ce57b3704821cff0d<br>&lt;signature&gt;&nbsp;:89dfefdc253147f32f5dc00e4a7042ebccdec663a422c80c1dd5ab69e9cc3304be2de1b0620cdef4749ccdffb4a8f4c4f704124e00f07b6efc3a722f173418a5</code></font></font></p><p

class="msonormal" style="margin-top: 0.66cm; margin-bottom: 0.4cm" lang="en-US"><span

style="display: inline-block; border-top: none; border-bottom: 1.00pt solid #09598a; border-left: none; border-right: none; padding-top: 0cm; padding-bottom: 0.05cm; padding-left: 0cm; padding-right: 0cm"><font

face="Segoe UI, sans-serif"><font style="font-size: 18pt" size="5"><b><font color="#09598a">10.4.
                Perl code example</font></b></font></font></span></p><p class="MsoNormal"

style="margin-bottom:0cm;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:black;mso-ansi-language:EN-US" lang="EN-US">
        </span><xmp>
use strict;
use strict;

use File::Spec::Functions;
use Data::Dumper;
use LWP::Simple;
use LWP;
use Data::Plist::BinaryWriter;
use Data::Plist::BinaryReader;
use feature qw(say);
use Crypt::SRP;
use Math::BigInt;
use Crypt::Digest::SHA512 qw (sha512);
use Crypt::AuthEnc::GCM qw(gcm_encrypt_authenticate gcm_decrypt_verify);
use Crypt::Ed25519;
use Crypt::Curve25519;
use Crypt::Mode::CTR;
use Encode qw(decode encode);

my $force  = 0;
my $host = 'http://192.168.1.10:7000';

sub step {
	my ($ua, $url, $param) = @_;
	my $req = HTTP::Request->new(POST => $url);
	
	return if $force;
	
	$req->header('Content-Type' => 'application/x-apple-binary-plist');
	# there was something strange with UA when set to itunes 12.x.y but can't remember what
	# $req->header('User-Agent' => 'iTunes/4.7.1 (Windows; N; Windows 7; 8664; EN; cp1252) SqueezeCenter, Squeezebox Server, Logitech Media Server');
	
	if (defined $param) {
		my $bplist = Data::Plist::BinaryWriter->new;
		$req->content($bplist->write($param));			 
	}	
	
	my $res = $ua->request($req);
	#say Dumper($res);
	return undef if !$res->content;
	
	my $bplist = Data::Plist::BinaryReader->new;
	my $data = $bplist->open_string($res->content)->data;	
	#say Dumper($data);
	
	return $data;
}

my $client_id = uc(unpack('H*', Crypt::PRNG::random_bytes(8)));
$client_id = '366B4165DD64AD3A' if ($force);
say ("<ID>    :", $client_id);

my $data;
my $param;
my $ua = LWP::UserAgent->new(keep_alive => 1);
$ua->timeout(2);

# step 0)
say "step ... 0";
step($ua, '$host/pair-pin-start');

# step 1)
say "step ... 1";
$param = { 'method' => 'pin', 'user' => $client_id};
$data = step($ua, '$host/pair-setup-pin', $param);

# step 2)
say "step ... 2";
my $client = Crypt::SRP->new('RFC5054-2048bit', 'SHA1');
my $pin;

if ($force) {
	$data->{pk} = Crypt::SRP::_bignum2bytes(Math::BigInt->new('0x4223ddb35967419ddfece40d6b552b797140129c1c262da1b83d413a7f9674aff834171336dabadf9faa95962331e44838d5f66c46649d583ee44827755651215dcd5881056f7fd7d6445b844ccc5793cc3bbd5887029a5abef8b173a3ad8f81326435e9d49818275734ef483b2541f4e2b99b838164ad5fe4a7cae40599fa41bd0e72cb5495bdd5189805da44b7df9b7ed29af326bb526725c2b1f4115f9d91e41638876eeb1db26ef6aed5373f72e3907cc72997ee9132a0dcafda24115730c9db904acbed6d81dc4b02200a5f5281bf321d5a3216a709191ce6ad36d383e79be76e37a2ed7082007c51717e099e7bedd7387c3f82a916d6aca2eb2b6ff3f3'));
	$data->{salt} = Crypt::SRP::_bignum2bytes(Math::BigInt->new('0xd62c98fe76c77ad445828c33063fc36f'));
	$client->{predefined_a} = Math::BigInt->new('0xa18b940d3e1302e932a64defccf560a0714b3fa2683bbe3cea808b3abfa58b7d');
	$pin = '1234';
} 

my ($A, $a) = $client->client_compute_A(32);
my $a_public = Crypt::Ed25519::eddsa_public_key($a);
say "<pk>    :", unpack("H*", $data->{pk});
say "<salt>  :", unpack("H*", $data->{salt});
say "<A>     :", unpack("H*", $A);
say "<a>     :", unpack("H*", $a);
say "<a_pub> :", unpack("H*", $a_public);
exit if !$client->client_verify_B($data->{pk});

if (!$force) {
	print "enter PIN: ";
	$pin = <STDIN>;
	chomp($pin);
}	

$client->client_init($client_id, $pin, $data->{salt});
my $M1 = $client->client_compute_M1;
say "<M1>    :", unpack("H*", $M1);

$param = { 'pk' => $A, 'proof' => $M1 };
$data = step($ua, '$host/pair-setup-pin', $param);

#exit if !$client->client_verify_M2($data->{proof});
my $K = $client->get_secret_K;
say "<K>     :", unpack("H*", $K);

# step 3)
say "step ... 3";
my $sha = Crypt::Digest::SHA512->new;

$sha->add( encode('UTF-8','Pair-Setup-AES-Key') );
$sha->add( $K );
my $aes_key = substr($sha->digest, 0, 16);
say "<aes_key>     :", unpack("H*", $aes_key);

$sha->reset;
$sha->add( encode('UTF-8','Pair-Setup-AES-IV') );
$sha->add( $K );
my $aes_iv = substr($sha->digest, 0, 16);
substr($aes_iv, -1, 1) = pack('C', unpack('C', substr($aes_iv, -1, 1)) + 1);
say "<aes_iv>      :", unpack("H*", $aes_iv);

my ($epk, $tag) = gcm_encrypt_authenticate('AES', $aes_key, $aes_iv, '', $a_public);
say "<epk>         :", unpack("H*", $epk);
say "<tag>         :", unpack("H*", $tag);

$param = { 'epk' => $epk, 'authTag' => $tag };
$data = step($ua, '$host/pair-setup-pin', $param);

if (defined $data) {
	say "SUCCESS";
} else {
	say "FAILED";	
}

my $credentials = $client_id . ":" . unpack("H*", $a);
say "credentials   :", $credentials;

# ============================= VERIFICATION ===================================

# verification 1)
my ($client_id, $a) = split(/:/, $credentials);
$a = pack("H*", $a);
my $a_public = Crypt::Ed25519::eddsa_public_key($a);
say "a_pub         :", unpack("H*", $a_public);

say "verify ... 1";
my $verifier = Crypt::Curve25519->new();
my $verify_secret_hex;
if ($force) {
	$verify_secret_hex = $verifier->secret_key( unpack('H*', $a ) );
} else {
	$verify_secret_hex = $verifier->secret_key( unpack('H*', Crypt::PRNG::random_bytes(32)) );
}

my $verify_public = pack("H*", $verifier->public_key( $verify_secret_hex ));
say "verify_pub    :", unpack("H*", $verify_public);

my $req = HTTP::Request->new(POST => '$host/pair-verify');
$req->header('Content-Type' => 'application/octet-stream');
$req->content("\x01\x00\x00\x00" . $verify_public . $a_public );			 
my $res = $ua->request($req);
#say Dumper($res);

$data = $res->content;
if ($force) {
	$data = pack("H*", 'd62c8c9548d836736978ad4d426df3495192407bbbb9466c9970794cdd2fe43a3067a3ea868ade5c9fab43a8d5dc4d53ca1115dbf1c882888f877e85b65c3a82a61583f24c33bf0b9a6ec5c4ab2ecc555a939e7633557453854795e82f2d7ef6');
}	

my $atv_public = substr($data, 0, 32);
my $atv_data = substr($data, 32);
say "atv_public    :", unpack("H*", $atv_public);
say "atv_data      :", unpack("H*", $atv_data);

# verification 2)
say "verify ... 2";

my $shared_secret = pack("H*", $verifier->shared_secret( $verify_secret_hex, unpack("H*", $atv_public)));
say "shared_secret :", unpack("H*", $shared_secret);

my $sha = Crypt::Digest::SHA512->new;

$sha->add( encode('UTF-8','Pair-Verify-AES-Key') );
$sha->add( $shared_secret );
my $aes_key = substr($sha->digest, 0, 16);
say "aes_key       :", unpack("H*", $aes_key);

$sha->reset;
$sha->add( encode('UTF-8','Pair-Verify-AES-IV') );
$sha->add( $shared_secret );
my $aes_iv = substr($sha->digest, 0, 16);
say "aes_iv        :", unpack("H*", $aes_iv);

my $signed = Crypt::Ed25519::eddsa_sign($verify_public . $atv_public, $a_public, $a);
#say "buf: ", unpack("H*", $verify_public . $atv_public);
say "signed        :", unpack("H*", $signed);

my $m = Crypt::Mode::CTR->new('AES', 1);
$m->start_encrypt($aes_key, $aes_iv);
$m->add($atv_data);
my $signature = $m->add($signed);
$signature = "\x00\x00\x00\x00" . $signature; 
say "signature     :", unpack("H*", $signature);

my $req = HTTP::Request->new(POST => '$host/pair-verify');
$req->header('Content-Type' => 'application/octet-stream');
$req->content($signature);			 
my $res = $ua->request($req);

if ($res->is_success) {
	say "VERIFIED";
} else {
	say "FAILED";	
}	
			 </xmp>
         </font></body></html>